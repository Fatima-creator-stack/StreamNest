class MovieWebsite {
    constructor() {
        // Try to load from regular storage first, then chunks
        this.loadMoviesData();
        this.currentPage = 1;
        this.moviesPerPage = 20;
        this.filteredMovies = [...this.movies];
        this.searchTimeout = null;
        this.adminMoviesPerPage = 10; // Pagination for admin panel
        this.adminCurrentPage = 1;

        this.init();
    }

    loadMoviesData() {
        try {
            // First try regular storage
            const regularData = localStorage.getItem('movies');
            if (regularData) {
                this.movies = JSON.parse(regularData);
                console.log('Movies loaded from regular storage:', this.movies.length, 'movies');
                return;
            }
        } catch (e) {
            console.log('Failed to load from regular storage, trying chunks...');
        }

        // Try chunks if regular storage failed
        const chunkedData = this.loadMoviesFromChunks();
        if (chunkedData) {
            this.movies = chunkedData;
            return;
        }

        // Initialize empty if nothing found
        this.movies = [];
        console.log('No movies found, initialized empty array');
    }

    init() {
        this.setupEventListeners();
        this.displayMovies();
        this.setupPagination();
        this.updateAdminButton();

        // Create directories if they don't exist (simulated)
        if (!localStorage.getItem('moviesInitialized')) {
            this.initializeDefaultMovies();
            localStorage.setItem('moviesInitialized', 'true');
        }
    }

    setupEventListeners() {
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        searchInput.addEventListener('input', (e) => {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.searchMovies(e.target.value);
            }, 300);
        });

        searchBtn.addEventListener('click', () => {
            this.searchMovies(searchInput.value);
        });

        // Input method toggle for admin form
        document.addEventListener('change', (e) => {
            if (e.target.name === 'inputMethod') {
                const urlInputs = document.getElementById('urlInputs');
                const fileInputs = document.getElementById('fileInputs');

                if (e.target.value === 'url') {
                    urlInputs.style.display = 'block';
                    fileInputs.style.display = 'none';
                } else {
                    urlInputs.style.display = 'none';
                    fileInputs.style.display = 'block';
                }
            }
        });

        // Modal event listeners
        const adminBtn = document.getElementById('adminBtn');
        const adminModal = document.getElementById('adminModal');
        const loginModal = document.getElementById('loginModal');
        const closeBtn = document.querySelector('#adminModal .close');
        const loginCloseBtn = document.querySelector('#loginModal .close');
        const adminForm = document.getElementById('adminForm');
        const loginForm = document.getElementById('loginForm');

        adminBtn.addEventListener('click', () => {
            loginModal.style.display = 'block';
        });

        closeBtn.addEventListener('click', () => {
            adminModal.style.display = 'none';
        });

        loginCloseBtn.addEventListener('click', () => {
            loginModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === adminModal) {
                adminModal.style.display = 'none';
            }
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleLogin();
        });

        adminForm.addEventListener('submit', (e) => {
            e.preventDefault();
            this.addMovie();
        });
    }

    handleLogin() {
        const password = document.getElementById('adminPassword').value;
        const correctPassword = 'tahahaya786'; // Change this to your desired password

        if (password === correctPassword) {
            localStorage.setItem('adminLoggedIn', 'true');
            localStorage.setItem('adminLoginTime', Date.now().toString());
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('adminModal').style.display = 'block';
            this.displayAdminMovies();
            this.updateAdminButton();
        } else {
            alert('Incorrect password!');
        }
    }

    isAdminLoggedIn() {
        const isLoggedIn = localStorage.getItem('adminLoggedIn');
        const loginTime = localStorage.getItem('adminLoginTime');

        if (!isLoggedIn || !loginTime) return false;

        // Session expires after 1 hour (3600000 ms)
        const sessionDuration = 3600000;
        const currentTime = Date.now();

        if (currentTime - parseInt(loginTime) > sessionDuration) {
            this.logout();
            return false;
        }

        return isLoggedIn === 'true';
    }

    logout() {
        localStorage.removeItem('adminLoggedIn');
        localStorage.removeItem('adminLoginTime');
        this.updateAdminButton();
    }

    searchMovies(query) {
        const searchTerm = query.toLowerCase().trim();

        if (searchTerm === '') {
            this.filteredMovies = [...this.movies];
        } else {
            // Optimized search with early exit
            this.filteredMovies = this.movies.filter(movie => {
                const titleMatch = movie.title.toLowerCase().includes(searchTerm);
                const descMatch = movie.description.toLowerCase().includes(searchTerm);
                return titleMatch || descMatch;
            });
        }

        this.currentPage = 1;
        this.displayMovies();
        this.setupPagination();
    }

    displayMovies() {
        const movieGrid = document.getElementById('movieGrid');
        const loading = document.getElementById('loading');

        loading.style.display = 'block';

        // Check if device is low-end (simple heuristic)
        const isLowEndDevice = navigator.hardwareConcurrency <= 2 || 
                              /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        const renderFunction = () => {
            const startIndex = (this.currentPage - 1) * this.moviesPerPage;
            const endIndex = startIndex + this.moviesPerPage;
            const moviesToShow = this.filteredMovies.slice(startIndex, endIndex);

            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();

            if (moviesToShow.length === 0) {
                const noResults = document.createElement('p');
                noResults.style.cssText = 'grid-column: 1/-1; text-align: center; font-size: 1.2rem; color: rgba(255,255,255,0.7);';
                noResults.textContent = 'No movies found matching your search.';
                fragment.appendChild(noResults);
            } else {
                moviesToShow.forEach((movie, index) => {
                    const movieCard = this.createMovieCard(movie, index);
                    fragment.appendChild(movieCard);
                });
            }

            movieGrid.innerHTML = '';
            movieGrid.appendChild(fragment);
            loading.style.display = 'none';

            // Initialize lazy loading for new images
            this.initializeLazyLoading();
        };

        // Use immediate rendering for low-end devices, requestAnimationFrame for others
        if (isLowEndDevice) {
            renderFunction();
        } else {
            requestAnimationFrame(renderFunction);
        }
    }

    createMovieCard(movie, index) {
        const card = document.createElement('div');
        card.className = 'movie-card';
        card.setAttribute('data-movie-id', movie.id);
        // Reduce or disable animations on low-end devices
        const isLowEndDevice = navigator.hardwareConcurrency <= 2 || 
                              /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (!isLowEndDevice) {
            card.style.animationDelay = `${Math.min(index * 0.05, 0.4)}s`;
        } else {
            card.style.animation = 'none';
            card.style.opacity = '1';
            card.style.transform = 'none';
        }

        const img = document.createElement('img');
        img.className = 'movie-poster lazy';
        img.setAttribute('data-src', movie.bannerUrl);
        img.alt = movie.title;
        img.loading = 'lazy';
        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiBmaWxsPSIjMjAyMDIwIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiNBQUFBQUEiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkxvYWRpbmcuLi48L3RleHQ+Cjwvc3ZnPgo=';
        
        const movieInfo = document.createElement('div');
        movieInfo.className = 'movie-info';
        
        const title = document.createElement('div');
        title.className = 'movie-title';
        title.textContent = movie.title;
        
        const description = document.createElement('div');
        description.className = 'movie-description';
        description.textContent = movie.description;
        
        movieInfo.appendChild(title);
        movieInfo.appendChild(description);
        card.appendChild(img);
        card.appendChild(movieInfo);

        // Use passive event listener for better performance
        card.addEventListener('click', () => {
            this.downloadMovie(movie);
        }, { passive: true });

        return card;
    }

    downloadMovie(movie) {
        // Get click count for this specific movie
        const movieClickKey = `clickCount_${movie.id}`;
        let clickCount = parseInt(localStorage.getItem(movieClickKey) || '0');

        // Increment click count
        clickCount++;
        localStorage.setItem(movieClickKey, clickCount.toString());

        // Check if user needs to view ads first
        if (clickCount <= 5) {
            // Show ad redirection message
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #ff6b35, #ff8c42);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                font-weight: bold;
                text-align: center;
                max-width: 300px;
            `;

            const remaining = 5 - clickCount + 1;
            notification.innerHTML = `
                <div style="margin-bottom: 8px;">Please view ad to continue</div>
                <div style="font-size: 0.9em; opacity: 0.9;">${remaining} more ${remaining === 1 ? 'click' : 'clicks'} until download</div>
            `;

            document.body.appendChild(notification);

            // Remove notification after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 4000);

            // Redirect to ad page
            window.open('https://otieu.com/4/9421362', '_blank');

        } else {
            // User has completed ad views, provide actual download
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                font-weight: bold;
            `;
            notification.textContent = `Starting download: ${movie.title}`;
            document.body.appendChild(notification);

            // Remove notification after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);

            // Trigger actual download
            if (movie.downloadUrl && movie.downloadUrl !== '#') {
                // Create a temporary link and click it to start download
                const link = document.createElement('a');
                link.href = movie.downloadUrl;
                link.download = `${movie.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.mp4`;
                link.target = '_blank';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Reset click count after successful download
                localStorage.removeItem(movieClickKey);

            } else {
                // Fallback for movies without download URLs
                setTimeout(() => {
                    alert(`Download URL not available for "${movie.title}". Please contact admin to add download link.`);
                }, 500);
            }
        }
    }

    setupPagination() {
        const pagination = document.getElementById('pagination');
        const totalPages = Math.ceil(this.filteredMovies.length / this.moviesPerPage);

        pagination.innerHTML = '';

        if (totalPages <= 1) return;

        // Previous button
        if (this.currentPage > 1) {
            const prevBtn = this.createPageButton('‹', this.currentPage - 1);
            pagination.appendChild(prevBtn);
        }

        // Page numbers
        const startPage = Math.max(1, this.currentPage - 2);
        const endPage = Math.min(totalPages, this.currentPage + 2);

        if (startPage > 1) {
            pagination.appendChild(this.createPageButton(1, 1));
            if (startPage > 2) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'page-btn';
                pagination.appendChild(ellipsis);
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = this.createPageButton(i, i);
            if (i === this.currentPage) {
                pageBtn.classList.add('active');
            }
            pagination.appendChild(pageBtn);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'page-btn';
                pagination.appendChild(ellipsis);
            }
            pagination.appendChild(this.createPageButton(totalPages, totalPages));
        }

        // Next button
        if (this.currentPage < totalPages) {
            const nextBtn = this.createPageButton('›', this.currentPage + 1);
            pagination.appendChild(nextBtn);
        }
    }

    createPageButton(text, page) {
        const btn = document.createElement('button');
        btn.textContent = text;
        btn.className = 'page-btn';
        btn.addEventListener('click', () => {
            this.currentPage = page;
            this.displayMovies();
            this.setupPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        return btn;
    }

    updateAdminButton() {
        const adminBtn = document.getElementById('adminBtn');
        if (this.isAdminLoggedIn()) {
            adminBtn.textContent = 'Admin Panel (Logout)';
            adminBtn.onclick = (e) => {
                e.preventDefault();
                if (confirm('Do you want to logout?')) {
                    this.logout();
                } else {
                    document.getElementById('adminModal').style.display = 'block';
                    this.displayAdminMovies();
                }
            };
        } else {
            adminBtn.textContent = 'Admin Panel';
            adminBtn.onclick = null;
        }
    }

    displayAdminMovies() {
        const adminMovieList = document.getElementById('adminMovieList');
        adminMovieList.innerHTML = '';

        if (this.movies.length === 0) {
            adminMovieList.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No movies added yet.</p>';
            return;
        }

        // Pagination for admin movies
        const startIndex = (this.adminCurrentPage - 1) * this.adminMoviesPerPage;
        const endIndex = startIndex + this.adminMoviesPerPage;
        const moviesToShow = this.movies.slice(startIndex, endIndex);

        moviesToShow.forEach(movie => {
            const movieClickKey = `clickCount_${movie.id}`;
            const clickCount = parseInt(localStorage.getItem(movieClickKey) || '0');
            const remaining = Math.max(0, 5 - clickCount);

            const movieItem = document.createElement('div');
            movieItem.className = 'admin-movie-item';
            movieItem.innerHTML = `
                <div style="flex: 1;">
                    <span style="font-weight: bold;">${movie.title}</span>
                    <br>
                    <small style="color: rgba(255,255,255,0.7);">
                        ${remaining > 0 ? `${remaining} ad clicks remaining` : 'Ready for download'}
                    </small>
                </div>
                <div>
                    <button class="reset-btn" onclick="movieWebsite.resetMovieClicks(${movie.id})" style="margin-right: 5px;">Reset Clicks</button>
                    <button class="delete-btn" onclick="movieWebsite.deleteMovie(${movie.id})">Delete</button>
                </div>
            `;
            adminMovieList.appendChild(movieItem);
        });

        // Add pagination for admin panel if needed
        if (this.movies.length > this.adminMoviesPerPage) {
            this.setupAdminPagination();
        }
    }

    setupAdminPagination() {
        const adminMovieList = document.getElementById('adminMovieList');
        const totalPages = Math.ceil(this.movies.length / this.adminMoviesPerPage);

        if (totalPages <= 1) return;

        const paginationDiv = document.createElement('div');
        paginationDiv.className = 'admin-pagination';
        paginationDiv.style.cssText = 'margin-top: 15px; text-align: center;';

        // Previous button
        if (this.adminCurrentPage > 1) {
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‹';
            prevBtn.className = 'admin-page-btn';
            prevBtn.style.cssText = 'margin: 0 5px; padding: 5px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 3px; cursor: pointer;';
            prevBtn.onclick = () => {
                this.adminCurrentPage--;
                this.displayAdminMovies();
            };
            paginationDiv.appendChild(prevBtn);
        }

        // Page info
        const pageInfo = document.createElement('span');
        pageInfo.textContent = `Page ${this.adminCurrentPage} of ${totalPages}`;
        pageInfo.style.cssText = 'color: rgba(255,255,255,0.8); margin: 0 10px;';
        paginationDiv.appendChild(pageInfo);

        // Next button
        if (this.adminCurrentPage < totalPages) {
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '›';
            nextBtn.className = 'admin-page-btn';
            nextBtn.style.cssText = 'margin: 0 5px; padding: 5px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 3px; cursor: pointer;';
            nextBtn.onclick = () => {
                this.adminCurrentPage++;
                this.displayAdminMovies();
            };
            paginationDiv.appendChild(nextBtn);
        }

        adminMovieList.appendChild(paginationDiv);
    }

    resetMovieClicks(movieId) {
        const movieClickKey = `clickCount_${movieId}`;
        localStorage.removeItem(movieClickKey);
        this.displayAdminMovies();

        const movie = this.movies.find(m => m.id === movieId);
        alert(`Click count reset for "${movie.title}". Users will need to view ads again.`);
    }

    deleteMovie(movieId) {
        if (confirm('Are you sure you want to delete this movie?')) {
            // Create backup before deletion
            this.createBackup();
            
            this.movies = this.movies.filter(movie => movie.id !== movieId);
            this.filteredMovies = this.filteredMovies.filter(movie => movie.id !== movieId);
            this.saveMovies();

            // Adjust admin pagination if needed
            const totalPages = Math.ceil(this.movies.length / this.adminMoviesPerPage);
            if (this.adminCurrentPage > totalPages && totalPages > 0) {
                this.adminCurrentPage = totalPages;
            }

            // Force refresh all displays
            this.displayMovies();
            this.setupPagination();
            this.displayAdminMovies();
            
            // Clean up click counts for deleted movie
            localStorage.removeItem(`clickCount_${movieId}`);
        }
    }

    // Add method to manually refresh movies (useful for debugging)
    refreshMovies() {
        this.loadMoviesData();
        this.filteredMovies = [...this.movies];
        this.currentPage = 1;
        this.displayMovies();
        this.setupPagination();
        if (this.isAdminLoggedIn()) {
            this.displayAdminMovies();
        }
        console.log('Movies refreshed:', this.movies.length, 'total movies');
    }

    saveMovies() {
        try {
            // Clear any existing chunks first
            this.clearMovieChunks();
            
            const moviesData = JSON.stringify(this.movies);
            
            // Try to save normally first
            localStorage.setItem('movies', moviesData);
            console.log('Movies saved successfully:', this.movies.length, 'movies');
            
        } catch (e) {
            console.log('Storage quota exceeded, saving in chunks...');
            // Clear the failed attempt
            localStorage.removeItem('movies');
            // Save in chunks for unlimited storage capability
            this.saveMoviesInChunks(JSON.stringify(this.movies));
        }
    }

    clearMovieChunks() {
        const chunkCount = parseInt(localStorage.getItem('movieChunks') || '0');
        for (let i = 0; i < chunkCount; i++) {
            localStorage.removeItem(`movieChunk_${i}`);
        }
        localStorage.removeItem('movieChunks');
    }

    saveMoviesInChunks(data) {
        const chunkSize = 500000; // 500KB chunks for better compatibility
        const chunks = [];

        for (let i = 0; i < data.length; i += chunkSize) {
            chunks.push(data.slice(i, i + chunkSize));
        }

        try {
            // Clear old chunks first
            this.clearMovieChunks();
            
            localStorage.setItem('movieChunks', chunks.length.toString());
            chunks.forEach((chunk, index) => {
                localStorage.setItem(`movieChunk_${index}`, chunk);
            });
            console.log('Movies saved in chunks:', chunks.length, 'chunks');
        } catch (e) {
            alert('Storage limit reached. Please clear some browser data and try again.');
            console.error('Chunk save failed:', e);
        }
    }

    loadMoviesFromChunks() {
        const chunkCount = parseInt(localStorage.getItem('movieChunks') || '0');
        if (chunkCount === 0) return null;

        let data = '';
        for (let i = 0; i < chunkCount; i++) {
            const chunk = localStorage.getItem(`movieChunk_${i}`);
            if (chunk === null) {
                console.error('Missing chunk:', i);
                return null;
            }
            data += chunk;
        }

        try {
            const movies = JSON.parse(data);
            console.log('Movies loaded from chunks:', movies.length, 'movies');
            return movies;
        } catch (e) {
            console.error('Failed to parse chunked data:', e);
            return null;
        }
    }

    createBackup() {
        const backupData = {
            movies: JSON.parse(JSON.stringify(this.movies)),
            timestamp: new Date().toISOString(),
            version: 1
        };
        localStorage.setItem('moviesBackup', JSON.stringify(backupData));
        return backupData;
    }

    restoreFromBackup() {
        const backupData = localStorage.getItem('moviesBackup');
        if (backupData) {
            try {
                const backup = JSON.parse(backupData);
                this.movies = backup.movies || [];
                this.filteredMovies = [...this.movies];
                this.saveMovies();
                this.displayMovies();
                this.setupPagination();
                this.displayAdminMovies();
                return true;
            } catch (e) {
                console.error('Failed to restore backup:', e);
                return false;
            }
        }
        return false;
    }

    showRestoreOption() {
        const backupData = localStorage.getItem('moviesBackup');
        if (backupData) {
            try {
                const backup = JSON.parse(backupData);
                const backupTime = new Date(backup.timestamp).toLocaleString();
                if (confirm(`A backup from ${backupTime} is available. Would you like to restore it?`)) {
                    if (this.restoreFromBackup()) {
                        alert('Data restored successfully from backup!');
                    } else {
                        alert('Failed to restore backup data.');
                    }
                }
            } catch (e) {
                console.error('Invalid backup data:', e);
            }
        }
    }

    addMovie() {
        const title = document.getElementById('movieTitle').value.trim();
        const description = document.getElementById('movieDescription').value.trim();
        const inputMethod = document.querySelector('input[name="inputMethod"]:checked').value;

        if (!title) {
            alert('Please enter a movie title.');
            return;
        }

        // Create backup before adding
        this.createBackup();

        let bannerUrl = '';
        let downloadUrl = '';

        if (inputMethod === 'url') {
            bannerUrl = document.getElementById('bannerUrl').value.trim();
            downloadUrl = document.getElementById('downloadUrl').value.trim();
        } else {
            // Handle file uploads (convert to data URLs for demo)
            const bannerFile = document.getElementById('movieBanner').files[0];
            const movieFile = document.getElementById('movieFile').files[0];

            if (bannerFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    bannerUrl = e.target.result;
                    this.processMovieAddition(title, description, bannerUrl, downloadUrl);
                };
                reader.readAsDataURL(bannerFile);
                return;
            }
        }

        this.processMovieAddition(title, description, bannerUrl, downloadUrl);
    }

    processMovieAddition(title, description, bannerUrl, downloadUrl) {
        const newMovie = {
            id: Date.now(),
            title: title,
            description: description || 'No description available.',
            bannerUrl: bannerUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiBmaWxsPSIjMUExQTFBIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiNGRkZGRkYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K',
            downloadUrl: downloadUrl || '#',
            dateAdded: new Date().toISOString()
        };

        this.movies.push(newMovie);
        this.filteredMovies = [...this.movies];
        
        // Save movies and ensure they're persisted
        this.saveMovies();
        
        // Force refresh of all displays
        this.currentPage = 1; // Reset to first page to show new movie
        this.displayMovies();
        this.setupPagination();
        this.displayAdminMovies();
        
        // Verify the movie was saved by reloading
        setTimeout(() => {
            this.loadMoviesData();
            this.filteredMovies = [...this.movies];
            if (this.movies.find(m => m.id === newMovie.id)) {
                console.log('Movie successfully saved and verified');
            } else {
                console.error('Movie save verification failed');
                alert('Warning: Movie may not have been saved properly. Please check if it appears on refresh.');
            }
        }, 100);

        // Reset form
        document.getElementById('adminForm').reset();
        document.getElementById('urlInputs').style.display = 'block';
        document.getElementById('fileInputs').style.display = 'none';

        // Show success message with undo option
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            font-weight: bold;
            max-width: 300px;
        `;
        notification.innerHTML = `
            <div style="margin-bottom: 10px;">Movie "${title}" added successfully!</div>
            <button onclick="movieWebsite.showRestoreOption(); this.parentNode.remove();" 
                    style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                Undo Last Change
            </button>
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    initializeLazyLoading() {
        if (this.imageObserver) {
            this.imageObserver.disconnect();
        }

        this.imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.getAttribute('data-src');
                    if (src) {
                        img.src = src;
                        img.classList.remove('lazy');
                        img.onerror = function() {
                            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiBmaWxsPSIjMUExQTFBIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiNGRkZGRkYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K';
                        };
                        this.imageObserver.unobserve(img);
                    }
                }
            });
        }, {
            rootMargin: '50px 0px',
            threshold: 0.01
        });

        // Observe all images with lazy class
        document.querySelectorAll('img.lazy').forEach(img => {
            this.imageObserver.observe(img);
        });
    }

    initializeDefaultMovies() {
        // Add some sample movies for demonstration
        const sampleMovies = [
            {
                id: 1,
                title: "The Dark Knight",
                description: "When the menace known as the Joker wreaks havoc and chaos on the people of Gotham...",
                bannerUrl: "https://picsum.photos/300/450?random=1",
                downloadUrl: "https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4",
                dateAdded: new Date().toISOString()
            },
            {
                id: 2,
                title: "Inception",
                description: "A thief who steals corporate secrets through dream-sharing technology...",
                bannerUrl: "https://picsum.photos/300/450?random=2",
                downloadUrl: "https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_2mb.mp4",
                dateAdded: new Date().toISOString()
            },
            {
                id: 3,
                title: "Interstellar",
                description: "A team of explorers travel through a wormhole in space...",
                bannerUrl: "https://picsum.photos/300/450?random=3",
                downloadUrl: "https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_5mb.mp4",
                dateAdded: new Date().toISOString()
            }
        ];

        this.movies = sampleMovies;
        this.filteredMovies = [...this.movies];
        this.saveMovies();
    }
}

// Initialize the website when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.movieWebsite = new MovieWebsite();
});

// Performance optimization: Lazy loading for images
document.addEventListener('DOMContentLoaded', () => {
    window.movieWebsite.initializeLazyLoading();
});

// Add throttle utility for performance
function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    }
}class MovieWebsite {
    constructor() {
        // Try to load from regular storage first, then chunks
        this.loadMoviesData();
        this.currentPage = 1;
        this.moviesPerPage = 20;
        this.filteredMovies = [...this.movies];
        this.searchTimeout = null;
        this.adminMoviesPerPage = 10; // Pagination for admin panel
        this.adminCurrentPage = 1;

        this.init();
    }

    loadMoviesData() {
        try {
            // First try regular storage
            const regularData = localStorage.getItem('movies');
            if (regularData) {
                this.movies = JSON.parse(regularData);
                console.log('Movies loaded from regular storage:', this.movies.length, 'movies');
                return;
            }
        } catch (e) {
            console.log('Failed to load from regular storage, trying chunks...');
        }

        // Try chunks if regular storage failed
        const chunkedData = this.loadMoviesFromChunks();
        if (chunkedData) {
            this.movies = chunkedData;
            return;
        }

        // Initialize empty if nothing found
        this.movies = [];
        console.log('No movies found, initialized empty array');
    }

    init() {
        this.setupEventListeners();
        this.displayMovies();
        this.setupPagination();
        this.updateAdminButton();

        // Create directories if they don't exist (simulated)
        if (!localStorage.getItem('moviesInitialized')) {
            this.initializeDefaultMovies();
            localStorage.setItem('moviesInitialized', 'true');
        }
    }

    setupEventListeners() {
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        searchInput.addEventListener('input', (e) => {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.searchMovies(e.target.value);
            }, 300);
        });

        searchBtn.addEventListener('click', () => {
            this.searchMovies(searchInput.value);
        });

        // Input method toggle for admin form
        document.addEventListener('change', (e) => {
            if (e.target.name === 'inputMethod') {
                const urlInputs = document.getElementById('urlInputs');
                const fileInputs = document.getElementById('fileInputs');

                if (e.target.value === 'url') {
                    urlInputs.style.display = 'block';
                    fileInputs.style.display = 'none';
                } else {
                    urlInputs.style.display = 'none';
                    fileInputs.style.display = 'block';
                }
            }
        });

        // Modal event listeners
        const adminBtn = document.getElementById('adminBtn');
        const adminModal = document.getElementById('adminModal');
        const loginModal = document.getElementById('loginModal');
        const closeBtn = document.querySelector('#adminModal .close');
        const loginCloseBtn = document.querySelector('#loginModal .close');
        const adminForm = document.getElementById('adminForm');
        const loginForm = document.getElementById('loginForm');

        adminBtn.addEventListener('click', () => {
            loginModal.style.display = 'block';
        });

        closeBtn.addEventListener('click', () => {
            adminModal.style.display = 'none';
        });

        loginCloseBtn.addEventListener('click', () => {
            loginModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === adminModal) {
                adminModal.style.display = 'none';
            }
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleLogin();
        });

        adminForm.addEventListener('submit', (e) => {
            e.preventDefault();
            this.addMovie();
        });
    }

    handleLogin() {
        const password = document.getElementById('adminPassword').value;
        const correctPassword = 'tahahaya786'; // Change this to your desired password

        if (password === correctPassword) {
            localStorage.setItem('adminLoggedIn', 'true');
            localStorage.setItem('adminLoginTime', Date.now().toString());
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('adminModal').style.display = 'block';
            this.displayAdminMovies();
            this.updateAdminButton();
        } else {
            alert('Incorrect password!');
        }
    }

    isAdminLoggedIn() {
        const isLoggedIn = localStorage.getItem('adminLoggedIn');
        const loginTime = localStorage.getItem('adminLoginTime');

        if (!isLoggedIn || !loginTime) return false;

        // Session expires after 1 hour (3600000 ms)
        const sessionDuration = 3600000;
        const currentTime = Date.now();

        if (currentTime - parseInt(loginTime) > sessionDuration) {
            this.logout();
            return false;
        }

        return isLoggedIn === 'true';
    }

    logout() {
        localStorage.removeItem('adminLoggedIn');
        localStorage.removeItem('adminLoginTime');
        this.updateAdminButton();
    }

    searchMovies(query) {
        const searchTerm = query.toLowerCase().trim();

        if (searchTerm === '') {
            this.filteredMovies = [...this.movies];
        } else {
            // Optimized search with early exit
            this.filteredMovies = this.movies.filter(movie => {
                const titleMatch = movie.title.toLowerCase().includes(searchTerm);
                const descMatch = movie.description.toLowerCase().includes(searchTerm);
                return titleMatch || descMatch;
            });
        }

        this.currentPage = 1;
        this.displayMovies();
        this.setupPagination();
    }

    displayMovies() {
        const movieGrid = document.getElementById('movieGrid');
        const loading = document.getElementById('loading');

        loading.style.display = 'block';

        // Check if device is low-end (simple heuristic)
        const isLowEndDevice = navigator.hardwareConcurrency <= 2 || 
                              /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        const renderFunction = () => {
            const startIndex = (this.currentPage - 1) * this.moviesPerPage;
            const endIndex = startIndex + this.moviesPerPage;
            const moviesToShow = this.filteredMovies.slice(startIndex, endIndex);

            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();

            if (moviesToShow.length === 0) {
                const noResults = document.createElement('p');
                noResults.style.cssText = 'grid-column: 1/-1; text-align: center; font-size: 1.2rem; color: rgba(255,255,255,0.7);';
                noResults.textContent = 'No movies found matching your search.';
                fragment.appendChild(noResults);
            } else {
                moviesToShow.forEach((movie, index) => {
                    const movieCard = this.createMovieCard(movie, index);
                    fragment.appendChild(movieCard);
                });
            }

            movieGrid.innerHTML = '';
            movieGrid.appendChild(fragment);
            loading.style.display = 'none';

            // Initialize lazy loading for new images
            this.initializeLazyLoading();
        };

        // Use immediate rendering for low-end devices, requestAnimationFrame for others
        if (isLowEndDevice) {
            renderFunction();
        } else {
            requestAnimationFrame(renderFunction);
        }
    }

    createMovieCard(movie, index) {
        const card = document.createElement('div');
        card.className = 'movie-card';
        card.setAttribute('data-movie-id', movie.id);
        // Reduce or disable animations on low-end devices
        const isLowEndDevice = navigator.hardwareConcurrency <= 2 || 
                              /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (!isLowEndDevice) {
            card.style.animationDelay = `${Math.min(index * 0.05, 0.4)}s`;
        } else {
            card.style.animation = 'none';
            card.style.opacity = '1';
            card.style.transform = 'none';
        }

        const img = document.createElement('img');
        img.className = 'movie-poster lazy';
        img.setAttribute('data-src', movie.bannerUrl);
        img.alt = movie.title;
        img.loading = 'lazy';
        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiBmaWxsPSIjMjAyMDIwIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiNBQUFBQUEiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkxvYWRpbmcuLi48L3RleHQ+Cjwvc3ZnPgo=';
        
        const movieInfo = document.createElement('div');
        movieInfo.className = 'movie-info';
        
        const title = document.createElement('div');
        title.className = 'movie-title';
        title.textContent = movie.title;
        
        const description = document.createElement('div');
        description.className = 'movie-description';
        description.textContent = movie.description;
        
        movieInfo.appendChild(title);
        movieInfo.appendChild(description);
        card.appendChild(img);
        card.appendChild(movieInfo);

        // Use passive event listener for better performance
        card.addEventListener('click', () => {
            this.downloadMovie(movie);
        }, { passive: true });

        return card;
    }

    downloadMovie(movie) {
        // Get click count for this specific movie
        const movieClickKey = `clickCount_${movie.id}`;
        let clickCount = parseInt(localStorage.getItem(movieClickKey) || '0');

        // Increment click count
        clickCount++;
        localStorage.setItem(movieClickKey, clickCount.toString());

        // Check if user needs to view ads first
        if (clickCount <= 5) {
            // Show ad redirection message
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #ff6b35, #ff8c42);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                font-weight: bold;
                text-align: center;
                max-width: 300px;
            `;

            const remaining = 5 - clickCount + 1;
            notification.innerHTML = `
                <div style="margin-bottom: 8px;">Please view ad to continue</div>
                <div style="font-size: 0.9em; opacity: 0.9;">${remaining} more ${remaining === 1 ? 'click' : 'clicks'} until download</div>
            `;

            document.body.appendChild(notification);

            // Remove notification after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 4000);

            // Redirect to ad page
            window.open('https://otieu.com/4/9421362', '_blank');

        } else {
            // User has completed ad views, provide actual download
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                font-weight: bold;
            `;
            notification.textContent = `Starting download: ${movie.title}`;
            document.body.appendChild(notification);

            // Remove notification after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);

            // Trigger actual download
            if (movie.downloadUrl && movie.downloadUrl !== '#') {
                // Create a temporary link and click it to start download
                const link = document.createElement('a');
                link.href = movie.downloadUrl;
                link.download = `${movie.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.mp4`;
                link.target = '_blank';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Reset click count after successful download
                localStorage.removeItem(movieClickKey);

            } else {
                // Fallback for movies without download URLs
                setTimeout(() => {
                    alert(`Download URL not available for "${movie.title}". Please contact admin to add download link.`);
                }, 500);
            }
        }
    }

    setupPagination() {
        const pagination = document.getElementById('pagination');
        const totalPages = Math.ceil(this.filteredMovies.length / this.moviesPerPage);

        pagination.innerHTML = '';

        if (totalPages <= 1) return;

        // Previous button
        if (this.currentPage > 1) {
            const prevBtn = this.createPageButton('‹', this.currentPage - 1);
            pagination.appendChild(prevBtn);
        }

        // Page numbers
        const startPage = Math.max(1, this.currentPage - 2);
        const endPage = Math.min(totalPages, this.currentPage + 2);

        if (startPage > 1) {
            pagination.appendChild(this.createPageButton(1, 1));
            if (startPage > 2) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'page-btn';
                pagination.appendChild(ellipsis);
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = this.createPageButton(i, i);
            if (i === this.currentPage) {
                pageBtn.classList.add('active');
            }
            pagination.appendChild(pageBtn);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'page-btn';
                pagination.appendChild(ellipsis);
            }
            pagination.appendChild(this.createPageButton(totalPages, totalPages));
        }

        // Next button
        if (this.currentPage < totalPages) {
            const nextBtn = this.createPageButton('›', this.currentPage + 1);
            pagination.appendChild(nextBtn);
        }
    }

    createPageButton(text, page) {
        const btn = document.createElement('button');
        btn.textContent = text;
        btn.className = 'page-btn';
        btn.addEventListener('click', () => {
            this.currentPage = page;
            this.displayMovies();
            this.setupPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        return btn;
    }

    updateAdminButton() {
        const adminBtn = document.getElementById('adminBtn');
        if (this.isAdminLoggedIn()) {
            adminBtn.textContent = 'Admin Panel (Logout)';
            adminBtn.onclick = (e) => {
                e.preventDefault();
                if (confirm('Do you want to logout?')) {
                    this.logout();
                } else {
                    document.getElementById('adminModal').style.display = 'block';
                    this.displayAdminMovies();
                }
            };
        } else {
            adminBtn.textContent = 'Admin Panel';
            adminBtn.onclick = null;
        }
    }

    displayAdminMovies() {
        const adminMovieList = document.getElementById('adminMovieList');
        adminMovieList.innerHTML = '';

        if (this.movies.length === 0) {
            adminMovieList.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No movies added yet.</p>';
            return;
        }

        // Pagination for admin movies
        const startIndex = (this.adminCurrentPage - 1) * this.adminMoviesPerPage;
        const endIndex = startIndex + this.adminMoviesPerPage;
        const moviesToShow = this.movies.slice(startIndex, endIndex);

        moviesToShow.forEach(movie => {
            const movieClickKey = `clickCount_${movie.id}`;
            const clickCount = parseInt(localStorage.getItem(movieClickKey) || '0');
            const remaining = Math.max(0, 5 - clickCount);

            const movieItem = document.createElement('div');
            movieItem.className = 'admin-movie-item';
            movieItem.innerHTML = `
                <div style="flex: 1;">
                    <span style="font-weight: bold;">${movie.title}</span>
                    <br>
                    <small style="color: rgba(255,255,255,0.7);">
                        ${remaining > 0 ? `${remaining} ad clicks remaining` : 'Ready for download'}
                    </small>
                </div>
                <div>
                    <button class="reset-btn" onclick="movieWebsite.resetMovieClicks(${movie.id})" style="margin-right: 5px;">Reset Clicks</button>
                    <button class="delete-btn" onclick="movieWebsite.deleteMovie(${movie.id})">Delete</button>
                </div>
            `;
            adminMovieList.appendChild(movieItem);
        });

        // Add pagination for admin panel if needed
        if (this.movies.length > this.adminMoviesPerPage) {
            this.setupAdminPagination();
        }
    }

    setupAdminPagination() {
        const adminMovieList = document.getElementById('adminMovieList');
        const totalPages = Math.ceil(this.movies.length / this.adminMoviesPerPage);

        if (totalPages <= 1) return;

        const paginationDiv = document.createElement('div');
        paginationDiv.className = 'admin-pagination';
        paginationDiv.style.cssText = 'margin-top: 15px; text-align: center;';

        // Previous button
        if (this.adminCurrentPage > 1) {
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‹';
            prevBtn.className = 'admin-page-btn';
            prevBtn.style.cssText = 'margin: 0 5px; padding: 5px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 3px; cursor: pointer;';
            prevBtn.onclick = () => {
                this.adminCurrentPage--;
                this.displayAdminMovies();
            };
            paginationDiv.appendChild(prevBtn);
        }

        // Page info
        const pageInfo = document.createElement('span');
        pageInfo.textContent = `Page ${this.adminCurrentPage} of ${totalPages}`;
        pageInfo.style.cssText = 'color: rgba(255,255,255,0.8); margin: 0 10px;';
        paginationDiv.appendChild(pageInfo);

        // Next button
        if (this.adminCurrentPage < totalPages) {
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '›';
            nextBtn.className = 'admin-page-btn';
            nextBtn.style.cssText = 'margin: 0 5px; padding: 5px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 3px; cursor: pointer;';
            nextBtn.onclick = () => {
                this.adminCurrentPage++;
                this.displayAdminMovies();
            };
            paginationDiv.appendChild(nextBtn);
        }

        adminMovieList.appendChild(paginationDiv);
    }

    resetMovieClicks(movieId) {
        const movieClickKey = `clickCount_${movieId}`;
        localStorage.removeItem(movieClickKey);
        this.displayAdminMovies();

        const movie = this.movies.find(m => m.id === movieId);
        alert(`Click count reset for "${movie.title}". Users will need to view ads again.`);
    }

    deleteMovie(movieId) {
        if (confirm('Are you sure you want to delete this movie?')) {
            // Create backup before deletion
            this.createBackup();
            
            this.movies = this.movies.filter(movie => movie.id !== movieId);
            this.filteredMovies = this.filteredMovies.filter(movie => movie.id !== movieId);
            this.saveMovies();

            // Adjust admin pagination if needed
            const totalPages = Math.ceil(this.movies.length / this.adminMoviesPerPage);
            if (this.adminCurrentPage > totalPages && totalPages > 0) {
                this.adminCurrentPage = totalPages;
            }

            // Force refresh all displays
            this.displayMovies();
            this.setupPagination();
            this.displayAdminMovies();
            
            // Clean up click counts for deleted movie
            localStorage.removeItem(`clickCount_${movieId}`);
        }
    }

    // Add method to manually refresh movies (useful for debugging)
    refreshMovies() {
        this.loadMoviesData();
        this.filteredMovies = [...this.movies];
        this.currentPage = 1;
        this.displayMovies();
        this.setupPagination();
        if (this.isAdminLoggedIn()) {
            this.displayAdminMovies();
        }
        console.log('Movies refreshed:', this.movies.length, 'total movies');
    }

    saveMovies() {
        try {
            // Clear any existing chunks first
            this.clearMovieChunks();
            
            const moviesData = JSON.stringify(this.movies);
            
            // Try to save normally first
            localStorage.setItem('movies', moviesData);
            console.log('Movies saved successfully:', this.movies.length, 'movies');
            
        } catch (e) {
            console.log('Storage quota exceeded, saving in chunks...');
            // Clear the failed attempt
            localStorage.removeItem('movies');
            // Save in chunks for unlimited storage capability
            this.saveMoviesInChunks(JSON.stringify(this.movies));
        }
    }

    clearMovieChunks() {
        const chunkCount = parseInt(localStorage.getItem('movieChunks') || '0');
        for (let i = 0; i < chunkCount; i++) {
            localStorage.removeItem(`movieChunk_${i}`);
        }
        localStorage.removeItem('movieChunks');
    }

    saveMoviesInChunks(data) {
        const chunkSize = 500000; // 500KB chunks for better compatibility
        const chunks = [];

        for (let i = 0; i < data.length; i += chunkSize) {
            chunks.push(data.slice(i, i + chunkSize));
        }

        try {
            // Clear old chunks first
            this.clearMovieChunks();
            
            localStorage.setItem('movieChunks', chunks.length.toString());
            chunks.forEach((chunk, index) => {
                localStorage.setItem(`movieChunk_${index}`, chunk);
            });
            console.log('Movies saved in chunks:', chunks.length, 'chunks');
        } catch (e) {
            alert('Storage limit reached. Please clear some browser data and try again.');
            console.error('Chunk save failed:', e);
        }
    }

    loadMoviesFromChunks() {
        const chunkCount = parseInt(localStorage.getItem('movieChunks') || '0');
        if (chunkCount === 0) return null;

        let data = '';
        for (let i = 0; i < chunkCount; i++) {
            const chunk = localStorage.getItem(`movieChunk_${i}`);
            if (chunk === null) {
                console.error('Missing chunk:', i);
                return null;
            }
            data += chunk;
        }

        try {
            const movies = JSON.parse(data);
            console.log('Movies loaded from chunks:', movies.length, 'movies');
            return movies;
        } catch (e) {
            console.error('Failed to parse chunked data:', e);
            return null;
        }
    }

    createBackup() {
        const backupData = {
            movies: JSON.parse(JSON.stringify(this.movies)),
            timestamp: new Date().toISOString(),
            version: 1
        };
        localStorage.setItem('moviesBackup', JSON.stringify(backupData));
        return backupData;
    }

    restoreFromBackup() {
        const backupData = localStorage.getItem('moviesBackup');
        if (backupData) {
            try {
                const backup = JSON.parse(backupData);
                this.movies = backup.movies || [];
                this.filteredMovies = [...this.movies];
                this.saveMovies();
                this.displayMovies();
                this.setupPagination();
                this.displayAdminMovies();
                return true;
            } catch (e) {
                console.error('Failed to restore backup:', e);
                return false;
            }
        }
        return false;
    }

    showRestoreOption() {
        const backupData = localStorage.getItem('moviesBackup');
        if (backupData) {
            try {
                const backup = JSON.parse(backupData);
                const backupTime = new Date(backup.timestamp).toLocaleString();
                if (confirm(`A backup from ${backupTime} is available. Would you like to restore it?`)) {
                    if (this.restoreFromBackup()) {
                        alert('Data restored successfully from backup!');
                    } else {
                        alert('Failed to restore backup data.');
                    }
                }
            } catch (e) {
                console.error('Invalid backup data:', e);
            }
        }
    }

    addMovie() {
        const title = document.getElementById('movieTitle').value.trim();
        const description = document.getElementById('movieDescription').value.trim();
        const inputMethod = document.querySelector('input[name="inputMethod"]:checked').value;

        if (!title) {
            alert('Please enter a movie title.');
            return;
        }

        // Create backup before adding
        this.createBackup();

        let bannerUrl = '';
        let downloadUrl = '';

        if (inputMethod === 'url') {
            bannerUrl = document.getElementById('bannerUrl').value.trim();
            downloadUrl = document.getElementById('downloadUrl').value.trim();
        } else {
            // Handle file uploads (convert to data URLs for demo)
            const bannerFile = document.getElementById('movieBanner').files[0];
            const movieFile = document.getElementById('movieFile').files[0];

            if (bannerFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    bannerUrl = e.target.result;
                    this.processMovieAddition(title, description, bannerUrl, downloadUrl);
                };
                reader.readAsDataURL(bannerFile);
                return;
            }
        }

        this.processMovieAddition(title, description, bannerUrl, downloadUrl);
    }

    processMovieAddition(title, description, bannerUrl, downloadUrl) {
        const newMovie = {
            id: Date.now(),
            title: title,
            description: description || 'No description available.',
            bannerUrl: bannerUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiBmaWxsPSIjMUExQTFBIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiNGRkZGRkYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K',
            downloadUrl: downloadUrl || '#',
            dateAdded: new Date().toISOString()
        };

        this.movies.push(newMovie);
        this.filteredMovies = [...this.movies];
        
        // Save movies and ensure they're persisted
        this.saveMovies();
        
        // Force refresh of all displays
        this.currentPage = 1; // Reset to first page to show new movie
        this.displayMovies();
        this.setupPagination();
        this.displayAdminMovies();
        
        // Verify the movie was saved by reloading
        setTimeout(() => {
            this.loadMoviesData();
            this.filteredMovies = [...this.movies];
            if (this.movies.find(m => m.id === newMovie.id)) {
                console.log('Movie successfully saved and verified');
            } else {
                console.error('Movie save verification failed');
                alert('Warning: Movie may not have been saved properly. Please check if it appears on refresh.');
            }
        }, 100);

        // Reset form
        document.getElementById('adminForm').reset();
        document.getElementById('urlInputs').style.display = 'block';
        document.getElementById('fileInputs').style.display = 'none';

        // Show success message with undo option
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            font-weight: bold;
            max-width: 300px;
        `;
        notification.innerHTML = `
            <div style="margin-bottom: 10px;">Movie "${title}" added successfully!</div>
            <button onclick="movieWebsite.showRestoreOption(); this.parentNode.remove();" 
                    style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                Undo Last Change
            </button>
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    initializeLazyLoading() {
        if (this.imageObserver) {
            this.imageObserver.disconnect();
        }

        this.imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.getAttribute('data-src');
                    if (src) {
                        img.src = src;
                        img.classList.remove('lazy');
                        img.onerror = function() {
                            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiBmaWxsPSIjMUExQTFBIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiNGRkZGRkYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K';
                        };
                        this.imageObserver.unobserve(img);
                    }
                }
            });
        }, {
            rootMargin: '50px 0px',
            threshold: 0.01
        });

        // Observe all images with lazy class
        document.querySelectorAll('img.lazy').forEach(img => {
            this.imageObserver.observe(img);
        });
    }

    initializeDefaultMovies() {
        // Add some sample movies for demonstration
        const sampleMovies = [
            {
                id: 1,
                title: "The Dark Knight",
                description: "When the menace known as the Joker wreaks havoc and chaos on the people of Gotham...",
                bannerUrl: "https://picsum.photos/300/450?random=1",
                downloadUrl: "https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4",
                dateAdded: new Date().toISOString()
            },
            {
                id: 2,
                title: "Inception",
                description: "A thief who steals corporate secrets through dream-sharing technology...",
                bannerUrl: "https://picsum.photos/300/450?random=2",
                downloadUrl: "https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_2mb.mp4",
                dateAdded: new Date().toISOString()
            },
            {
                id: 3,
                title: "Interstellar",
                description: "A team of explorers travel through a wormhole in space...",
                bannerUrl: "https://picsum.photos/300/450?random=3",
                downloadUrl: "https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_5mb.mp4",
                dateAdded: new Date().toISOString()
            }
        ];

        this.movies = sampleMovies;
        this.filteredMovies = [...this.movies];
        this.saveMovies();
    }
}

// Initialize the website when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.movieWebsite = new MovieWebsite();
});

// Performance optimization: Lazy loading for images
document.addEventListener('DOMContentLoaded', () => {
    window.movieWebsite.initializeLazyLoading();
});

// Add throttle utility for performance
function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    }
}class MovieWebsite {
    constructor() {
        // Try to load from regular storage first, then chunks
        this.loadMoviesData();
        this.currentPage = 1;
        this.moviesPerPage = 20;
        this.filteredMovies = [...this.movies];
        this.searchTimeout = null;
        this.adminMoviesPerPage = 10; // Pagination for admin panel
        this.adminCurrentPage = 1;

        this.init();
    }

    loadMoviesData() {
        try {
            // First try regular storage
            const regularData = localStorage.getItem('movies');
            if (regularData) {
                this.movies = JSON.parse(regularData);
                console.log('Movies loaded from regular storage:', this.movies.length, 'movies');
                return;
            }
        } catch (e) {
            console.log('Failed to load from regular storage, trying chunks...');
        }

        // Try chunks if regular storage failed
        const chunkedData = this.loadMoviesFromChunks();
        if (chunkedData) {
            this.movies = chunkedData;
            return;
        }

        // Initialize empty if nothing found
        this.movies = [];
        console.log('No movies found, initialized empty array');
    }

    init() {
        this.setupEventListeners();
        this.displayMovies();
        this.setupPagination();
        this.updateAdminButton();

        // Create directories if they don't exist (simulated)
        if (!localStorage.getItem('moviesInitialized')) {
            this.initializeDefaultMovies();
            localStorage.setItem('moviesInitialized', 'true');
        }
    }

    setupEventListeners() {
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        searchInput.addEventListener('input', (e) => {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.searchMovies(e.target.value);
            }, 300);
        });

        searchBtn.addEventListener('click', () => {
            this.searchMovies(searchInput.value);
        });

        // Input method toggle for admin form
        document.addEventListener('change', (e) => {
            if (e.target.name === 'inputMethod') {
                const urlInputs = document.getElementById('urlInputs');
                const fileInputs = document.getElementById('fileInputs');

                if (e.target.value === 'url') {
                    urlInputs.style.display = 'block';
                    fileInputs.style.display = 'none';
                } else {
                    urlInputs.style.display = 'none';
                    fileInputs.style.display = 'block';
                }
            }
        });

        // Modal event listeners
        const adminBtn = document.getElementById('adminBtn');
        const adminModal = document.getElementById('adminModal');
        const loginModal = document.getElementById('loginModal');
        const closeBtn = document.querySelector('#adminModal .close');
        const loginCloseBtn = document.querySelector('#loginModal .close');
        const adminForm = document.getElementById('adminForm');
        const loginForm = document.getElementById('loginForm');

        adminBtn.addEventListener('click', () => {
            loginModal.style.display = 'block';
        });

        closeBtn.addEventListener('click', () => {
            adminModal.style.display = 'none';
        });

        loginCloseBtn.addEventListener('click', () => {
            loginModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === adminModal) {
                adminModal.style.display = 'none';
            }
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleLogin();
        });

        adminForm.addEventListener('submit', (e) => {
            e.preventDefault();
            this.addMovie();
        });
    }

    handleLogin() {
        const password = document.getElementById('adminPassword').value;
        const correctPassword = 'tahahaya786'; // Change this to your desired password

        if (password === correctPassword) {
            localStorage.setItem('adminLoggedIn', 'true');
            localStorage.setItem('adminLoginTime', Date.now().toString());
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('adminModal').style.display = 'block';
            this.displayAdminMovies();
            this.updateAdminButton();
        } else {
            alert('Incorrect password!');
        }
    }

    isAdminLoggedIn() {
        const isLoggedIn = localStorage.getItem('adminLoggedIn');
        const loginTime = localStorage.getItem('adminLoginTime');

        if (!isLoggedIn || !loginTime) return false;

        // Session expires after 1 hour (3600000 ms)
        const sessionDuration = 3600000;
        const currentTime = Date.now();

        if (currentTime - parseInt(loginTime) > sessionDuration) {
            this.logout();
            return false;
        }

        return isLoggedIn === 'true';
    }

    logout() {
        localStorage.removeItem('adminLoggedIn');
        localStorage.removeItem('adminLoginTime');
        this.updateAdminButton();
    }

    searchMovies(query) {
        const searchTerm = query.toLowerCase().trim();

        if (searchTerm === '') {
            this.filteredMovies = [...this.movies];
        } else {
            // Optimized search with early exit
            this.filteredMovies = this.movies.filter(movie => {
                const titleMatch = movie.title.toLowerCase().includes(searchTerm);
                const descMatch = movie.description.toLowerCase().includes(searchTerm);
                return titleMatch || descMatch;
            });
        }

        this.currentPage = 1;
        this.displayMovies();
        this.setupPagination();
    }

    displayMovies() {
        const movieGrid = document.getElementById('movieGrid');
        const loading = document.getElementById('loading');

        loading.style.display = 'block';

        // Check if device is low-end (simple heuristic)
        const isLowEndDevice = navigator.hardwareConcurrency <= 2 || 
                              /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        const renderFunction = () => {
            const startIndex = (this.currentPage - 1) * this.moviesPerPage;
            const endIndex = startIndex + this.moviesPerPage;
            const moviesToShow = this.filteredMovies.slice(startIndex, endIndex);

            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();

            if (moviesToShow.length === 0) {
                const noResults = document.createElement('p');
                noResults.style.cssText = 'grid-column: 1/-1; text-align: center; font-size: 1.2rem; color: rgba(255,255,255,0.7);';
                noResults.textContent = 'No movies found matching your search.';
                fragment.appendChild(noResults);
            } else {
                moviesToShow.forEach((movie, index) => {
                    const movieCard = this.createMovieCard(movie, index);
                    fragment.appendChild(movieCard);
                });
            }

            movieGrid.innerHTML = '';
            movieGrid.appendChild(fragment);
            loading.style.display = 'none';

            // Initialize lazy loading for new images
            this.initializeLazyLoading();
        };

        // Use immediate rendering for low-end devices, requestAnimationFrame for others
        if (isLowEndDevice) {
            renderFunction();
        } else {
            requestAnimationFrame(renderFunction);
        }
    }

    createMovieCard(movie, index) {
        const card = document.createElement('div');
        card.className = 'movie-card';
        card.setAttribute('data-movie-id', movie.id);
        // Reduce or disable animations on low-end devices
        const isLowEndDevice = navigator.hardwareConcurrency <= 2 || 
                              /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (!isLowEndDevice) {
            card.style.animationDelay = `${Math.min(index * 0.05, 0.4)}s`;
        } else {
            card.style.animation = 'none';
            card.style.opacity = '1';
            card.style.transform = 'none';
        }

        const img = document.createElement('img');
        img.className = 'movie-poster lazy';
        img.setAttribute('data-src', movie.bannerUrl);
        img.alt = movie.title;
        img.loading = 'lazy';
        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiBmaWxsPSIjMjAyMDIwIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiNBQUFBQUEiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkxvYWRpbmcuLi48L3RleHQ+Cjwvc3ZnPgo=';
        
        const movieInfo = document.createElement('div');
        movieInfo.className = 'movie-info';
        
        const title = document.createElement('div');
        title.className = 'movie-title';
        title.textContent = movie.title;
        
        const description = document.createElement('div');
        description.className = 'movie-description';
        description.textContent = movie.description;
        
        movieInfo.appendChild(title);
        movieInfo.appendChild(description);
        card.appendChild(img);
        card.appendChild(movieInfo);

        // Use passive event listener for better performance
        card.addEventListener('click', () => {
            this.downloadMovie(movie);
        }, { passive: true });

        return card;
    }

    downloadMovie(movie) {
        // Get click count for this specific movie
        const movieClickKey = `clickCount_${movie.id}`;
        let clickCount = parseInt(localStorage.getItem(movieClickKey) || '0');

        // Increment click count
        clickCount++;
        localStorage.setItem(movieClickKey, clickCount.toString());

        // Check if user needs to view ads first
        if (clickCount <= 5) {
            // Show ad redirection message
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #ff6b35, #ff8c42);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                font-weight: bold;
                text-align: center;
                max-width: 300px;
            `;

            const remaining = 5 - clickCount + 1;
            notification.innerHTML = `
                <div style="margin-bottom: 8px;">Please view ad to continue</div>
                <div style="font-size: 0.9em; opacity: 0.9;">${remaining} more ${remaining === 1 ? 'click' : 'clicks'} until download</div>
            `;

            document.body.appendChild(notification);

            // Remove notification after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 4000);

            // Redirect to ad page
            window.open('https://otieu.com/4/9421362', '_blank');

        } else {
            // User has completed ad views, provide actual download
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                font-weight: bold;
            `;
            notification.textContent = `Starting download: ${movie.title}`;
            document.body.appendChild(notification);

            // Remove notification after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);

            // Trigger actual download
            if (movie.downloadUrl && movie.downloadUrl !== '#') {
                // Create a temporary link and click it to start download
                const link = document.createElement('a');
                link.href = movie.downloadUrl;
                link.download = `${movie.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.mp4`;
                link.target = '_blank';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Reset click count after successful download
                localStorage.removeItem(movieClickKey);

            } else {
                // Fallback for movies without download URLs
                setTimeout(() => {
                    alert(`Download URL not available for "${movie.title}". Please contact admin to add download link.`);
                }, 500);
            }
        }
    }

    setupPagination() {
        const pagination = document.getElementById('pagination');
        const totalPages = Math.ceil(this.filteredMovies.length / this.moviesPerPage);

        pagination.innerHTML = '';

        if (totalPages <= 1) return;

        // Previous button
        if (this.currentPage > 1) {
            const prevBtn = this.createPageButton('‹', this.currentPage - 1);
            pagination.appendChild(prevBtn);
        }

        // Page numbers
        const startPage = Math.max(1, this.currentPage - 2);
        const endPage = Math.min(totalPages, this.currentPage + 2);

        if (startPage > 1) {
            pagination.appendChild(this.createPageButton(1, 1));
            if (startPage > 2) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'page-btn';
                pagination.appendChild(ellipsis);
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = this.createPageButton(i, i);
            if (i === this.currentPage) {
                pageBtn.classList.add('active');
            }
            pagination.appendChild(pageBtn);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'page-btn';
                pagination.appendChild(ellipsis);
            }
            pagination.appendChild(this.createPageButton(totalPages, totalPages));
        }

        // Next button
        if (this.currentPage < totalPages) {
            const nextBtn = this.createPageButton('›', this.currentPage + 1);
            pagination.appendChild(nextBtn);
        }
    }

    createPageButton(text, page) {
        const btn = document.createElement('button');
        btn.textContent = text;
        btn.className = 'page-btn';
        btn.addEventListener('click', () => {
            this.currentPage = page;
            this.displayMovies();
            this.setupPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        return btn;
    }

    updateAdminButton() {
        const adminBtn = document.getElementById('adminBtn');
        if (this.isAdminLoggedIn()) {
            adminBtn.textContent = 'Admin Panel (Logout)';
            adminBtn.onclick = (e) => {
                e.preventDefault();
                if (confirm('Do you want to logout?')) {
                    this.logout();
                } else {
                    document.getElementById('adminModal').style.display = 'block';
                    this.displayAdminMovies();
                }
            };
        } else {
            adminBtn.textContent = 'Admin Panel';
            adminBtn.onclick = null;
        }
    }

    displayAdminMovies() {
        const adminMovieList = document.getElementById('adminMovieList');
        adminMovieList.innerHTML = '';

        if (this.movies.length === 0) {
            adminMovieList.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No movies added yet.</p>';
            return;
        }

        // Pagination for admin movies
        const startIndex = (this.adminCurrentPage - 1) * this.adminMoviesPerPage;
        const endIndex = startIndex + this.adminMoviesPerPage;
        const moviesToShow = this.movies.slice(startIndex, endIndex);

        moviesToShow.forEach(movie => {
            const movieClickKey = `clickCount_${movie.id}`;
            const clickCount = parseInt(localStorage.getItem(movieClickKey) || '0');
            const remaining = Math.max(0, 5 - clickCount);

            const movieItem = document.createElement('div');
            movieItem.className = 'admin-movie-item';
            movieItem.innerHTML = `
                <div style="flex: 1;">
                    <span style="font-weight: bold;">${movie.title}</span>
                    <br>
                    <small style="color: rgba(255,255,255,0.7);">
                        ${remaining > 0 ? `${remaining} ad clicks remaining` : 'Ready for download'}
                    </small>
                </div>
                <div>
                    <button class="reset-btn" onclick="movieWebsite.resetMovieClicks(${movie.id})" style="margin-right: 5px;">Reset Clicks</button>
                    <button class="delete-btn" onclick="movieWebsite.deleteMovie(${movie.id})">Delete</button>
                </div>
            `;
            adminMovieList.appendChild(movieItem);
        });

        // Add pagination for admin panel if needed
        if (this.movies.length > this.adminMoviesPerPage) {
            this.setupAdminPagination();
        }
    }

    setupAdminPagination() {
        const adminMovieList = document.getElementById('adminMovieList');
        const totalPages = Math.ceil(this.movies.length / this.adminMoviesPerPage);

        if (totalPages <= 1) return;

        const paginationDiv = document.createElement('div');
        paginationDiv.className = 'admin-pagination';
        paginationDiv.style.cssText = 'margin-top: 15px; text-align: center;';

        // Previous button
        if (this.adminCurrentPage > 1) {
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‹';
            prevBtn.className = 'admin-page-btn';
            prevBtn.style.cssText = 'margin: 0 5px; padding: 5px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 3px; cursor: pointer;';
            prevBtn.onclick = () => {
                this.adminCurrentPage--;
                this.displayAdminMovies();
            };
            paginationDiv.appendChild(prevBtn);
        }

        // Page info
        const pageInfo = document.createElement('span');
        pageInfo.textContent = `Page ${this.adminCurrentPage} of ${totalPages}`;
        pageInfo.style.cssText = 'color: rgba(255,255,255,0.8); margin: 0 10px;';
        paginationDiv.appendChild(pageInfo);

        // Next button
        if (this.adminCurrentPage < totalPages) {
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '›';
            nextBtn.className = 'admin-page-btn';
            nextBtn.style.cssText = 'margin: 0 5px; padding: 5px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 3px; cursor: pointer;';
            nextBtn.onclick = () => {
                this.adminCurrentPage++;
                this.displayAdminMovies();
            };
            paginationDiv.appendChild(nextBtn);
        }

        adminMovieList.appendChild(paginationDiv);
    }

    resetMovieClicks(movieId) {
        const movieClickKey = `clickCount_${movieId}`;
        localStorage.removeItem(movieClickKey);
        this.displayAdminMovies();

        const movie = this.movies.find(m => m.id === movieId);
        alert(`Click count reset for "${movie.title}". Users will need to view ads again.`);
    }

    deleteMovie(movieId) {
        if (confirm('Are you sure you want to delete this movie?')) {
            // Create backup before deletion
            this.createBackup();
            
            this.movies = this.movies.filter(movie => movie.id !== movieId);
            this.filteredMovies = this.filteredMovies.filter(movie => movie.id !== movieId);
            this.saveMovies();

            // Adjust admin pagination if needed
            const totalPages = Math.ceil(this.movies.length / this.adminMoviesPerPage);
            if (this.adminCurrentPage > totalPages && totalPages > 0) {
                this.adminCurrentPage = totalPages;
            }

            // Force refresh all displays
            this.displayMovies();
            this.setupPagination();
            this.displayAdminMovies();
            
            // Clean up click counts for deleted movie
            localStorage.removeItem(`clickCount_${movieId}`);
        }
    }

    // Add method to manually refresh movies (useful for debugging)
    refreshMovies() {
        this.loadMoviesData();
        this.filteredMovies = [...this.movies];
        this.currentPage = 1;
        this.displayMovies();
        this.setupPagination();
        if (this.isAdminLoggedIn()) {
            this.displayAdminMovies();
        }
        console.log('Movies refreshed:', this.movies.length, 'total movies');
    }

    saveMovies() {
        try {
            // Clear any existing chunks first
            this.clearMovieChunks();
            
            const moviesData = JSON.stringify(this.movies);
            
            // Try to save normally first
            localStorage.setItem('movies', moviesData);
            console.log('Movies saved successfully:', this.movies.length, 'movies');
            
        } catch (e) {
            console.log('Storage quota exceeded, saving in chunks...');
            // Clear the failed attempt
            localStorage.removeItem('movies');
            // Save in chunks for unlimited storage capability
            this.saveMoviesInChunks(JSON.stringify(this.movies));
        }
    }

    clearMovieChunks() {
        const chunkCount = parseInt(localStorage.getItem('movieChunks') || '0');
        for (let i = 0; i < chunkCount; i++) {
            localStorage.removeItem(`movieChunk_${i}`);
        }
        localStorage.removeItem('movieChunks');
    }

    saveMoviesInChunks(data) {
        const chunkSize = 500000; // 500KB chunks for better compatibility
        const chunks = [];

        for (let i = 0; i < data.length; i += chunkSize) {
            chunks.push(data.slice(i, i + chunkSize));
        }

        try {
            // Clear old chunks first
            this.clearMovieChunks();
            
            localStorage.setItem('movieChunks', chunks.length.toString());
            chunks.forEach((chunk, index) => {
                localStorage.setItem(`movieChunk_${index}`, chunk);
            });
            console.log('Movies saved in chunks:', chunks.length, 'chunks');
        } catch (e) {
            alert('Storage limit reached. Please clear some browser data and try again.');
            console.error('Chunk save failed:', e);
        }
    }

    loadMoviesFromChunks() {
        const chunkCount = parseInt(localStorage.getItem('movieChunks') || '0');
        if (chunkCount === 0) return null;

        let data = '';
        for (let i = 0; i < chunkCount; i++) {
            const chunk = localStorage.getItem(`movieChunk_${i}`);
            if (chunk === null) {
                console.error('Missing chunk:', i);
                return null;
            }
            data += chunk;
        }

        try {
            const movies = JSON.parse(data);
            console.log('Movies loaded from chunks:', movies.length, 'movies');
            return movies;
        } catch (e) {
            console.error('Failed to parse chunked data:', e);
            return null;
        }
    }

    createBackup() {
        const backupData = {
            movies: JSON.parse(JSON.stringify(this.movies)),
            timestamp: new Date().toISOString(),
            version: 1
        };
        localStorage.setItem('moviesBackup', JSON.stringify(backupData));
        return backupData;
    }

    restoreFromBackup() {
        const backupData = localStorage.getItem('moviesBackup');
        if (backupData) {
            try {
                const backup = JSON.parse(backupData);
                this.movies = backup.movies || [];
                this.filteredMovies = [...this.movies];
                this.saveMovies();
                this.displayMovies();
                this.setupPagination();
                this.displayAdminMovies();
                return true;
            } catch (e) {
                console.error('Failed to restore backup:', e);
                return false;
            }
        }
        return false;
    }

    showRestoreOption() {
        const backupData = localStorage.getItem('moviesBackup');
        if (backupData) {
            try {
                const backup = JSON.parse(backupData);
                const backupTime = new Date(backup.timestamp).toLocaleString();
                if (confirm(`A backup from ${backupTime} is available. Would you like to restore it?`)) {
                    if (this.restoreFromBackup()) {
                        alert('Data restored successfully from backup!');
                    } else {
                        alert('Failed to restore backup data.');
                    }
                }
            } catch (e) {
                console.error('Invalid backup data:', e);
            }
        }
    }

    addMovie() {
        const title = document.getElementById('movieTitle').value.trim();
        const description = document.getElementById('movieDescription').value.trim();
        const inputMethod = document.querySelector('input[name="inputMethod"]:checked').value;

        if (!title) {
            alert('Please enter a movie title.');
            return;
        }

        // Create backup before adding
        this.createBackup();

        let bannerUrl = '';
        let downloadUrl = '';

        if (inputMethod === 'url') {
            bannerUrl = document.getElementById('bannerUrl').value.trim();
            downloadUrl = document.getElementById('downloadUrl').value.trim();
        } else {
            // Handle file uploads (convert to data URLs for demo)
            const bannerFile = document.getElementById('movieBanner').files[0];
            const movieFile = document.getElementById('movieFile').files[0];

            if (bannerFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    bannerUrl = e.target.result;
                    this.processMovieAddition(title, description, bannerUrl, downloadUrl);
                };
                reader.readAsDataURL(bannerFile);
                return;
            }
        }

        this.processMovieAddition(title, description, bannerUrl, downloadUrl);
    }

    processMovieAddition(title, description, bannerUrl, downloadUrl) {
        const newMovie = {
            id: Date.now(),
            title: title,
            description: description || 'No description available.',
            bannerUrl: bannerUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiBmaWxsPSIjMUExQTFBIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiNGRkZGRkYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K',
            downloadUrl: downloadUrl || '#',
            dateAdded: new Date().toISOString()
        };

        this.movies.push(newMovie);
        this.filteredMovies = [...this.movies];
        
        // Save movies and ensure they're persisted
        this.saveMovies();
        
        // Force refresh of all displays
        this.currentPage = 1; // Reset to first page to show new movie
        this.displayMovies();
        this.setupPagination();
        this.displayAdminMovies();
        
        // Verify the movie was saved by reloading
        setTimeout(() => {
            this.loadMoviesData();
            this.filteredMovies = [...this.movies];
            if (this.movies.find(m => m.id === newMovie.id)) {
                console.log('Movie successfully saved and verified');
            } else {
                console.error('Movie save verification failed');
                alert('Warning: Movie may not have been saved properly. Please check if it appears on refresh.');
            }
        }, 100);

        // Reset form
        document.getElementById('adminForm').reset();
        document.getElementById('urlInputs').style.display = 'block';
        document.getElementById('fileInputs').style.display = 'none';

        // Show success message with undo option
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            font-weight: bold;
            max-width: 300px;
        `;
        notification.innerHTML = `
            <div style="margin-bottom: 10px;">Movie "${title}" added successfully!</div>
            <button onclick="movieWebsite.showRestoreOption(); this.parentNode.remove();" 
                    style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                Undo Last Change
            </button>
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    initializeLazyLoading() {
        if (this.imageObserver) {
            this.imageObserver.disconnect();
        }

        this.imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.getAttribute('data-src');
                    if (src) {
                        img.src = src;
                        img.classList.remove('lazy');
                        img.onerror = function() {
                            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiBmaWxsPSIjMUExQTFBIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiNGRkZGRkYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K';
                        };
                        this.imageObserver.unobserve(img);
                    }
                }
            });
        }, {
            rootMargin: '50px 0px',
            threshold: 0.01
        });

        // Observe all images with lazy class
        document.querySelectorAll('img.lazy').forEach(img => {
            this.imageObserver.observe(img);
        });
    }

    initializeDefaultMovies() {
        // Add some sample movies for demonstration
        const sampleMovies = [
            {
                id: 1,
                title: "The Dark Knight",
                description: "When the menace known as the Joker wreaks havoc and chaos on the people of Gotham...",
                bannerUrl: "https://picsum.photos/300/450?random=1",
                downloadUrl: "https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4",
                dateAdded: new Date().toISOString()
            },
            {
                id: 2,
                title: "Inception",
                description: "A thief who steals corporate secrets through dream-sharing technology...",
                bannerUrl: "https://picsum.photos/300/450?random=2",
                downloadUrl: "https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_2mb.mp4",
                dateAdded: new Date().toISOString()
            },
            {
                id: 3,
                title: "Interstellar",
                description: "A team of explorers travel through a wormhole in space...",
                bannerUrl: "https://picsum.photos/300/450?random=3",
                downloadUrl: "https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_5mb.mp4",
                dateAdded: new Date().toISOString()
            }
        ];

        this.movies = sampleMovies;
        this.filteredMovies = [...this.movies];
        this.saveMovies();
    }
}

// Initialize the website when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.movieWebsite = new MovieWebsite();
});

// Performance optimization: Lazy loading for images
document.addEventListener('DOMContentLoaded', () => {
    window.movieWebsite.initializeLazyLoading();
});

// Add throttle utility for performance
function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    }
}
